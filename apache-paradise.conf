# Paradise Dental Clinic - Apache VirtualHost Configuration
# For Hostinger Business Shared Hosting
# Place this in /home/username/conf/ or provide to Hostinger support

<VirtualHost *:80>
    ServerName paradisedental.com
    ServerAlias www.paradisedental.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName paradisedental.com
    ServerAlias www.paradisedental.com

    # Document root for frontend (React build)
    DocumentRoot /home/username/public_html

    # SSL Configuration (Hostinger manages SSL certificates)
    SSLEngine on
    SSLCertificateFile /home/username/ssl/certificate.crt
    SSLCertificateKeyFile /home/username/ssl/private.key
    SSLCertificateChainFile /home/username/ssl/ca_bundle.crt

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # HSTS (enable after confirming HTTPS works)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Gzip Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # Cache Control for Static Assets
    <IfModule mod_expires.c>
        ExpiresActive On

        # Frontend assets (Vite fingerprints files, safe to cache long)
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"

        # HTML - no cache (SPA entry point)
        ExpiresByType text/html "access plus 0 seconds"
    </IfModule>

    # Frontend (React SPA) - Serve index.html for all non-file routes
    <Directory /home/username/public_html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # React Router support - fallback to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Backend API Proxy (Node.js on port 3000)
    ProxyPreserveHost On
    ProxyRequests Off

    # API routes -> Node.js backend
    ProxyPass /api http://127.0.0.1:3000/api
    ProxyPassReverse /api http://127.0.0.1:3000/api

    # Health check endpoints
    ProxyPass /health http://127.0.0.1:3000/health
    ProxyPassReverse /health http://127.0.0.1:3000/health
    ProxyPass /ready http://127.0.0.1:3000/ready
    ProxyPassReverse /ready http://127.0.0.1:3000/ready

    # Uploads directory (static file serving)
    Alias /uploads /home/username/backend/uploads
    <Directory /home/username/backend/uploads>
        Options -Indexes
        AllowOverride None
        Require all granted

        # Security: Only allow image files
        <FilesMatch "\.(jpg|jpeg|png|gif|webp)$">
            Require all granted
        </FilesMatch>
        <FilesMatch "\.(?!jpg|jpeg|png|gif|webp$)[^.]+$">
            Require all denied
        </FilesMatch>
    </Directory>

    # Deny access to sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    <FilesMatch "\.(env|json|lock|md|yml|yaml)$">
        Require all denied
    </FilesMatch>

    # Error documents
    ErrorDocument 404 /index.html
    ErrorDocument 500 /index.html

    # Logging (adjust paths for Hostinger)
    ErrorLog /home/username/logs/error.log
    CustomLog /home/username/logs/access.log combined
</VirtualHost>

# =============================================================
# ALTERNATIVE: .htaccess for public_html (if VirtualHost not available)
# =============================================================
# Place the following content in /home/username/public_html/.htaccess
#
# RewriteEngine On
# RewriteBase /
#
# # Force HTTPS
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
#
# # API Proxy (requires mod_proxy enabled)
# RewriteCond %{REQUEST_URI} ^/api
# RewriteRule ^api/(.*)$ http://127.0.0.1:3000/api/$1 [P,L]
#
# # React Router - fallback to index.html
# RewriteRule ^index\.html$ - [L]
# RewriteCond %{REQUEST_FILENAME} !-f
# RewriteCond %{REQUEST_FILENAME} !-d
# RewriteRule . /index.html [L]
#
# # Security headers
# Header always set X-Content-Type-Options "nosniff"
# Header always set X-Frame-Options "SAMEORIGIN"
# Header always set X-XSS-Protection "1; mode=block"
# =============================================================
