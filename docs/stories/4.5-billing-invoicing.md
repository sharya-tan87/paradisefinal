# Story 4.5: Billing and Invoicing

## Status
Done

## Story
**As a** Staff Member or Manager,
**I want** to generate invoices from treatment records and track payment status,
**so that** I can manage clinic revenue and patient billing accurately.

## Acceptance Criteria
1. Billing page accessible at `/dashboard/billing` for staff, manager, admin (NOT dentist, patient)
2. Display list of invoices: invoice number, patient name/HN, date, total amount, payment status
3. Create invoice from patient's completed treatments
4. Invoice includes: invoice number (auto-generated), patient info, treatment line items, subtotal, tax, total
5. Invoice number format: "INV-YYYY-NNNNN" (e.g., "INV-2025-00001")
6. Payment status: unpaid, partially-paid, paid
7. Mark invoice as paid (update status, record payment date and method)
8. Generate PDF invoice (simple HTML-to-PDF or placeholder "Print" button)
9. API: GET /api/invoices, POST /api/invoices, PATCH /api/invoices/:id/payment
10. Invoice model with fields: id, invoiceNumber, patientHN, invoiceDate, dueDate, lineItems (JSON), subtotal, taxAmount, totalAmount, paymentStatus, paymentDate, paymentMethod
11. Filter invoices by status, patient, date range
12. Brand-compliant invoice design (white background, Teal headings, clinic logo placeholder)
13. RBAC: staff, manager, admin only
14. Display payment history for each invoice
15. Calculate tax (7% VAT for Thailand)

## Tasks / Subtasks

- [ ] **Task 1: Create Invoice Model and Migration** (AC: 10)
  - [ ] Create `backend/models/Invoice.js`
  - [ ] Fields: id (UUID), invoiceNumber (unique), patientHN (FK), invoiceDate, dueDate, lineItems (JSON array of treatment IDs + costs), subtotal, taxAmount, totalAmount, paymentStatus (enum), paymentDate, paymentMethod, created_by
  - [ ] Create migration
  - [ ] Add indexes on invoiceNumber, patientHN, paymentStatus

- [ ] **Task 2: Implement Invoice Controller** (AC: 3, 9)
  - [ ] Create `backend/controllers/invoiceController.js`
  - [ ] `listInvoices`: GET /api/invoices?status=XXX&patientHN=XXX&startDate=XXX&endDate=XXX
  - [ ] `createInvoice`: POST /api/invoices (fetch completed treatments for patient, calculate totals)
  - [ ] `getInvoice`: GET /api/invoices/:invoiceNumber
  - [ ] `recordPayment`: PATCH /api/invoices/:id/payment (update status, paymentDate, paymentMethod)

- [ ] **Task 3: Invoice Number Generation** (AC: 5)
  - [ ] Add static method `generateInvoiceNumber()` to Invoice model
  - [ ] Format: "INV-YYYY-NNNNN"
  - [ ] Query last invoice of current year, increment counter

- [ ] **Task 4: Create Invoice Routes with RBAC** (AC: 13)
  - [ ] Create `backend/routes/invoiceRoutes.js`
  - [ ] Apply authorizeRole(['staff', 'manager', 'admin'])
  - [ ] Mount at `/api/invoices`

- [ ] **Task 5: Create Billing Page** (AC: 1, 2, 11)
  - [ ] Create `frontend/src/pages/BillingPage.jsx`
  - [ ] Display invoices in table (desktop) / cards (mobile)
  - [ ] Columns: Invoice #, Patient, Date, Amount, Status, Actions
  - [ ] Filter dropdowns: Status (all/unpaid/paid), Date range
  - [ ] Search by patient HN or name
  - [ ] "Create Invoice" button

- [ ] **Task 6: Create Invoice Form Modal** (AC: 3, 4, 15)
  - [ ] Create `CreateInvoiceModal` component
  - [ ] Select patient (search dropdown)
  - [ ] Fetch patient's completed treatments (GET /api/treatments?patientHN=XXX&status=completed)
  - [ ] Display treatments as selectable line items (checkbox, description, cost)
  - [ ] Calculate subtotal (sum of selected treatments)
  - [ ] Calculate tax (subtotal × 0.07)
  - [ ] Calculate total (subtotal + tax)
  - [ ] Save button calls POST /api/invoices

- [ ] **Task 7: Display Invoice Details** (AC: 4, 12)
  - [ ] Create `ViewInvoiceModal` or separate page
  - [ ] Branded invoice template:
    - Clinic logo/name (placeholder)
    - Invoice number, date, due date
    - Patient info (name, HN, address)
    - Line items table (treatment description, date, cost)
    - Subtotal, Tax (7%), Total
  - [ ] Style with brand colors (white bg, Deep Navy text, Teal accents)

- [ ] **Task 8: Record Payment Modal** (AC: 7, 14)
  - [ ] Create `RecordPaymentModal` component
  - [ ] Fields: payment date, payment method (cash/credit/transfer), amount paid
  - [ ] Update paymentStatus:
    - If amount = total → "paid"
    - If 0 < amount < total → "partially-paid"
    - If amount = 0 → "unpaid"
  - [ ] Call PATCH /api/invoices/:id/payment

- [ ] **Task 9: Payment Status Badge** (AC: 6)
  - [ ] Create status badge component
  - [ ] Colors:
    - unpaid: red background
    - partially-paid: amber background
    - paid: green background
  - [ ] Display in invoice list

- [ ] **Task 10: Print/PDF Invoice** (AC: 8)
  - [ ] Add "Print" button that opens browser print dialog
  - [ ] Use CSS `@media print` to format invoice for printing
  - [ ] Hide navigation, buttons in print view
  - [ ] Future enhancement: server-side PDF generation with libraries (PDFKit, Puppeteer)

- [ ] **Task 11: Update Staff Dashboard Navigation** (AC: 1)
  - [ ] "Billing" link active for staff/manager/admin
  - [ ] Link to `/dashboard/billing`
  - [ ] Hide from dentist and patient roles

- [ ] **Task 12: Testing and Validation**
  - [ ] Create invoice from patient's treatments → invoice generated with correct totals
  - [ ] Tax calculated correctly (7%)
  - [ ] Record payment → status updates to "paid"
  - [ ] Filter by unpaid status → shows only unpaid invoices
  - [ ] Print invoice → displays branded template
  - [ ] RBAC: staff/manager can access, dentist cannot

## Dev Notes

### Dependencies
Requires Epic 3, Story 4.2 (Patient), Story 4.4 (Treatment for line items).

### Invoice Model Schema
```javascript
{
  id: DataTypes.UUID,
  invoiceNumber: DataTypes.STRING(50), // "INV-2025-00001"
  patientHN: DataTypes.STRING(50), // FK
  invoiceDate: DataTypes.DATEONLY,
  dueDate: DataTypes.DATEONLY,
  lineItems: DataTypes.JSON, // [{ treatmentId, description, cost }]
  subtotal: DataTypes.DECIMAL(10, 2),
  taxAmount: DataTypes.DECIMAL(10, 2),
  totalAmount: DataTypes.DECIMAL(10, 2),
  paymentStatus: DataTypes.ENUM('unpaid', 'partially-paid', 'paid'),
  paymentDate: DataTypes.DATEONLY,
  paymentMethod: DataTypes.STRING(50), // 'cash', 'credit', 'transfer'
  createdBy: DataTypes.UUID,
  created_at: DataTypes.DATE,
  updated_at: DataTypes.DATE
}
```

### Tax Calculation (Thailand VAT)
- Subtotal = Sum of line item costs
- Tax = Subtotal × 0.07 (7%)
- Total = Subtotal + Tax

### File Locations
**Backend:**
- `models/Invoice.js` (NEW)
- `controllers/invoiceController.js` (NEW)
- `routes/invoiceRoutes.js` (NEW)

**Frontend:**
- `pages/BillingPage.jsx` (NEW)
- `components/CreateInvoiceModal.jsx` (NEW)
- `components/ViewInvoiceModal.jsx` (NEW)
- `components/RecordPaymentModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 4.5 | Bob (Scrum Master) |

## Dev Agent Record
Implemented Invoice model with auto-generated invoice numbers (INV-YYYY-NNNNN), controller with CRUD operations and payment recording, routes with RBAC (staff/manager/admin only). Created BillingPage with invoice list, filters, summary cards. Created CreateInvoiceModal for selecting patient and completed treatments with automatic VAT calculation (7%). Created ViewInvoiceModal with print functionality and RecordPaymentModal for payment status updates. Updated navigation in StaffDashboard.

## QA Results
_To be filled by QA Agent_
