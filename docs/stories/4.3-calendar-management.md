# Story 4.3: Calendar Management - Appointment Scheduling

## Status
Done

## Story
**As a** Staff Member or Dentist,
**I want** a calendar view to manage appointments and schedules,
**so that** I can finalize bookings, reschedule appointments, and view daily/weekly schedules.

## Acceptance Criteria
1. Calendar page accessible at `/dashboard/calendar` for staff, dentist, manager, admin
2. Calendar displays appointments in month, week, and day views
3. Appointments show: patient name, service type, time slot, status badge
4. Create new appointment from calendar (click date/time slot)
5. Edit appointment by clicking existing appointment event
6. Drag-and-drop to reschedule appointments (optional enhancement)
7. Appointment model with fields: id, patientHN, appointmentDate, startTime, endTime, serviceType, status, dentistId, notes
8. API endpoints: GET /api/appointments/calendar, POST /api/appointments, PATCH /api/appointments/:id, DELETE /api/appointments/:id
9. Link calendar appointments to patient records via patientHN
10. Appointment status: scheduled, confirmed, in-progress, completed, cancelled, no-show
11. Time slots: 30-minute intervals from 9:00 AM to 6:00 PM
12. FullCalendar.io library integrated with brand styling (white theme)
13. Filter by dentist (dropdown) for dentist-specific schedules
14. Brand-compliant colors, Prompt font
15. RBAC protected (staff, dentist, manager, admin)

## Tasks / Subtasks

- [x] **Task 1: Create Appointment Model and Migration** (AC: 7)
  - [x] Create `backend/models/Appointment.js`
  - [x] Fields: id (UUID), patientHN (FK to Patient), appointmentDate, startTime, endTime, serviceType, status (enum), dentistId (FK to User), notes, created_by, updated_by
  - [x] Add foreign keys to Patient.hn and User.id
  - [x] Create migration
  - [x] Add indexes

- [x] **Task 2: Implement Appointment Controller** (AC: 8)
  - [x] Create `backend/controllers/appointmentController.js` (different from appointmentRequestController)
  - [x] `getCalendarAppointments`: GET /api/appointments/calendar?start=YYYY-MM-DD&end=YYYY-MM-DD&dentistId=UUID
  - [x] `createAppointment`: POST /api/appointments
  - [x] `updateAppointment`: PATCH /api/appointments/:id
  - [x] `deleteAppointment`: DELETE /api/appointments/:id (soft delete)

- [x] **Task 3: Create Calendar Routes** (AC: 15)
  - [x] Create `backend/routes/calendarRoutes.js`
  - [x] Apply RBAC: authenticate + authorizeRole(['staff', 'dentist', 'manager', 'admin'])
  - [x] Mount at `/api/appointments/calendar` and `/api/appointments`

- [x] **Task 4: Install and Configure FullCalendar.io** (AC: 2, 12)
  - [x] Install FullCalendar: `npm install @fullcalendar/react @fullcalendar/daygrid @fullcalendar/timegrid @fullcalendar/interaction`
  - [x] Create `frontend/src/pages/CalendarPage.jsx`
  - [x] Import FullCalendar components
  - [x] Configure views: month, week, day
  - [x] Customize theme with brand colors (white background, Teal Blue events)

- [x] **Task 5: Fetch and Display Calendar Events** (AC: 3, 9)
  - [x] Call GET /api/appointments/calendar on date range change
  - [x] Transform appointment data to FullCalendar event format:
    ```javascript
    {
      id: appointment.id,
      title: `${appointment.patientName} - ${appointment.serviceType}`,
      start: `${appointment.appointmentDate}T${appointment.startTime}`,
      end: `${appointment.appointmentDate}T${appointment.endTime}`,
      backgroundColor: getStatusColor(appointment.status),
      extendedProps: { ...appointment }
    }
    ```
  - [x] Display events on calendar

- [x] **Task 6: Create Appointment Form Modal** (AC: 4, 5)
  - [x] Create `AppointmentFormModal` component
  - [x] Form fields: patient (searchable dropdown by HN/name), date, start time, end time, service type, dentist, notes
  - [x] Validation: all required fields, end time > start time, no overlapping appointments
  - [x] Save button calls POST (create) or PATCH (edit)

- [x] **Task 7: Handle Calendar Interactions** (AC: 4, 5)
  - [x] On date/time click: open modal in create mode with pre-filled date/time
  - [x] On event click: open modal in edit mode with existing appointment data
  - [x] On successful save: close modal, refresh calendar

- [x] **Task 8: Add Dentist Filter Dropdown** (AC: 13)
  - [x] Fetch list of dentists (GET /api/users?role=dentist)
  - [x] Dropdown: "All Dentists" or select specific dentist
  - [x] On change, re-fetch calendar with dentistId filter
  - [x] Style dropdown with brand colors

- [x] **Task 9: Implement Status Badge in Events** (AC: 3, 10)
  - [x] Status colors:
    - scheduled: blue
    - confirmed: green
    - in-progress: amber
    - completed: gray
    - cancelled: red
    - no-show: dark gray
  - [x] Apply background color to calendar events based on status

- [x] **Task 10: Update Staff Dashboard Navigation**
  - [x] Change "Calendar" from coming soon to active link `/dashboard/calendar`

- [x] **Task 11: Testing and Validation**
  - [x] Create appointment from calendar → saves, displays on calendar
  - [x] Edit appointment → updates successfully
  - [x] Delete appointment → soft deletes, removes from calendar
  - [x] Filter by dentist → shows only that dentist's appointments
  - [x] Switch views (month/week/day) → displays correctly
  - [x] RBAC: staff/dentist can access, patient cannot

## Dev Notes

### Dependencies
Requires Epic 3, Story 4.1, and Story 4.2 (Patient model for FK relationship).

### Appointment Model Schema
```javascript
{
  id: DataTypes.UUID,
  patientHN: DataTypes.STRING(50), // FK to Patient.hn
  appointmentDate: DataTypes.DATEONLY,
  startTime: DataTypes.TIME,
  endTime: DataTypes.TIME,
  serviceType: DataTypes.STRING,
  status: DataTypes.ENUM('scheduled', 'confirmed', 'in-progress', 'completed', 'cancelled', 'no-show'),
  dentistId: DataTypes.UUID, // FK to User.id (role=dentist)
  notes: DataTypes.TEXT,
  createdBy: DataTypes.UUID,
  updatedBy: DataTypes.UUID,
  active: DataTypes.BOOLEAN,
  created_at: DataTypes.DATE,
  updated_at: DataTypes.DATE
}
```

### FullCalendar Brand Styling
```javascript
<FullCalendar
  plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
  initialView="timeGridWeek"
  headerToolbar={{
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay'
  }}
  slotMinTime="09:00:00"
  slotMaxTime="18:00:00"
  slotDuration="00:30:00"
  allDaySlot={false}
  eventColor="#2D7C9C" // Teal Blue
  height="auto"
  dateClick={handleDateClick}
  eventClick={handleEventClick}
/>
```

### File Locations
**Backend:**
- `models/Appointment.js` (NEW)
- `controllers/calendarController.js` (NEW)
- `routes/calendarRoutes.js` (NEW)

**Frontend:**
- `pages/CalendarPage.jsx` (NEW)
- `components/AppointmentFormModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 4.3 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
