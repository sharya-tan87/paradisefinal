# Story 4.2: Patient Registration - Internal CRUD

## Status
Done

## Story
**As a** Staff Member or Dentist,
**I want** to create and manage detailed patient records with medical history,
**so that** I can maintain comprehensive patient information for treatment planning.

## Acceptance Criteria
1. Patient management accessible at `/dashboard/patients` for staff, dentist, manager, admin roles
2. Patient list displays: HN (Hospital Number), name, DOB, phone, email, last visit date
3. Create Patient form includes: HN (auto-generated), title, first name, last name, DOB, gender, phone, email, address, emergency contact, medical history, allergies, medications
4. Edit Patient allows updating all fields except HN
5. View Patient displays full record in readonly mode with treatment history placeholder
6. Delete Patient soft-deletes record (sets active=false, not actual deletion)
7. Search/filter by HN, name, phone, or email
8. HN format: "HN-YYYY-NNNNN" (e.g., "HN-2025-00001")
9. Backend API: GET /api/patients, POST /api/patients, GET /api/patients/:hn, PATCH /api/patients/:hn, DELETE /api/patients/:hn
10. Patient model with Sequelize migration and validation
11. All operations RBAC protected (staff, dentist, manager, admin)
12. Brand-compliant UI with responsive design
13. Form validation: required fields, email format, phone format (Thai), DOB must be past date
14. Success/error messages displayed with brand colors
15. Pagination for patient list (20 per page)

## Tasks / Subtasks

- [x] **Task 1: Create Patient Model and Migration** (AC: 8, 10)
  - [x] Create `backend/models/Patient.js` Sequelize model
  - [x] Fields: id (UUID), hn (unique, auto-generated), title, firstName, lastName, dateOfBirth, gender, phone, email, address, emergencyContactName, emergencyContactPhone, medical history, allergies, current medications, active (boolean, default true)
  - [x] Add static method `generateHN()` - format: "HN-YYYY-NNNNN"
  - [x] Create migration file
  - [x] Add indexes on hn, email, phone
  - [x] Run migration

- [x] **Task 2: Implement Patient Controller** (AC: 9)
  - [x] Create `backend/controllers/patientController.js`
  - [x] `listPatients`: GET /api/patients (pagination, search filters)
  - [x] `createPatient`: POST /api/patients (generate HN, validate data)
  - [x] `getPatient`: GET /api/patients/:hn
  - [x] `updatePatient`: PATCH /api/patients/:hn
  - [x] `deletePatient`: DELETE /api/patients/:hn (soft delete: set active=false)

- [x] **Task 3: Create Patient Routes with RBAC** (AC: 11)
  - [x] Create `backend/routes/patientRoutes.js`
  - [x] Apply authenticate + authorizeRole(['staff', 'dentist', 'manager', 'admin']) to all routes
  - [x] Mount routes at `/api/patients` in server.js

- [x] **Task 4: Create Patient List Page** (AC: 1, 2, 7, 15)
  - [x] Create `frontend/src/pages/PatientsPage.jsx`
  - [x] Display table (desktop) / cards (mobile) with patient data
  - [x] Add search input (HN, name, phone, email)
  - [x] Add "New Patient" button (Teal Blue)
  - [x] Implement pagination controls
  - [x] Action buttons: View, Edit, Delete per patient

- [x] **Task 5: Create Patient Form Component** (AC: 3, 4, 13)
  - [x] Create `frontend/src/components/PatientForm.jsx`
  - [x] Use React Hook Form + Yup validation
  - [x] Form fields: title (select), firstName, lastName, DOB (date picker), gender (radio), phone, email, address (textarea), emergency contact fields, medical history (textarea), allergies (textarea), medications (textarea)
  - [x] Validation: required fields (name, DOB, phone), email format, phone format (Thai), DOB < today
  - [x] Display inline validation errors
  - [x] Reusable for Create and Edit modes

- [x] **Task 6: Create/Edit Patient Modals** (AC: 3, 4, 14)
  - [x] Create modal for New Patient (calls POST /api/patients)
  - [x] Create modal for Edit Patient (calls PATCH /api/patients/:hn)
  - [x] Pre-populate form on Edit mode
  - [x] Show success message on save, close modal, refresh list
  - [x] Show error message if API fails

- [x] **Task 7: View Patient Details** (AC: 5)
  - [x] Create `ViewPatientModal` component
  - [x] Display all patient fields in readonly format
  - [x] Show HN prominently at top
  - [x] Include placeholder section: "Treatment History (Coming Soon)"
  - [x] Close button

- [x] **Task 8: Implement Delete Confirmation** (AC: 6)
  - [x] Create delete confirmation modal
  - [x] Warning message: "Are you sure you want to deactivate this patient record?"
  - [x] Confirm button calls DELETE /api/patients/:hn
  - [x] Soft delete sets active=false, doesn't remove from database
  - [x] Refresh list after deletion

- [x] **Task 9: Update Staff Dashboard Navigation** (AC: 1)
  - [x] Update `StaffDashboard.jsx` navigation
  - [x] Change "Patient Records" from coming soon to active link `/dashboard/patients`

- [x] **Task 10: Testing and Validation**
  - [x] Create new patient → HN auto-generated, saves to DB
  - [x] Edit patient → updates successfully
  - [x] View patient → displays all data
  - [x] Delete patient → sets active=false, patient still in DB
  - [x] Search by HN → finds correct patient
  - [x] Search by name → finds matches
  - [x] Pagination works correctly
  - [x] Form validation displays errors
  - [x] RBAC: staff/dentist can access, patient cannot

## Dev Notes

### Previous Story Context
Epic 3 provided authentication, RBAC, and dashboard navigation.
Story 4.1 established queue management pattern (list, view, update).

**Dependencies:** Requires Epic 2, Epic 3, and Story 4.1 completed.

### Patient Model Schema
```javascript
{
  id: DataTypes.UUID,
  hn: DataTypes.STRING(50), // "HN-2025-00001"
  title: DataTypes.ENUM('Mr.', 'Ms.', 'Mrs.', 'Dr.'),
  firstName: DataTypes.STRING(100),
  lastName: DataTypes.STRING(100),
  dateOfBirth: DataTypes.DATEONLY,
  gender: DataTypes.ENUM('male', 'female', 'other'),
  phone: DataTypes.STRING(20),
  email: DataTypes.STRING(100),
  address: DataTypes.TEXT,
  emergencyContactName: DataTypes.STRING(100),
  emergencyContactPhone: DataTypes.STRING(20),
  medicalHistory: DataTypes.TEXT,
  allergies: DataTypes.TEXT,
  currentMedications: DataTypes.TEXT,
  active: DataTypes.BOOLEAN, // true=active, false=soft deleted
  created_at: DataTypes.DATE,
  updated_at: DataTypes.DATE
}
```

### HN Generation Logic
```javascript
static async generateHN() {
  const year = new Date().getFullYear();
  const lastPatient = await Patient.findOne({
    where: { hn: { [Op.like]: `HN-${year}-%` } },
    order: [['id', 'DESC']]
  });

  let nextNum = 1;
  if (lastPatient) {
    const lastNum = parseInt(lastPatient.hn.split('-')[2]);
    nextNum = lastNum + 1;
  }

  return `HN-${year}-${String(nextNum).padStart(5, '0')}`;
}
```

### File Locations
**Backend:**
- `models/Patient.js` (NEW)
- `migrations/YYYYMMDDHHMMSS-create-patients.js` (NEW)
- `controllers/patientController.js` (NEW)
- `routes/patientRoutes.js` (NEW)

**Frontend:**
- `pages/PatientsPage.jsx` (NEW)
- `components/PatientForm.jsx` (NEW)
- `components/ViewPatientModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 4.2 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
