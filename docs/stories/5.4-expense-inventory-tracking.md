# Story 5.4: Expense and Inventory Tracking

## Status
Done

## Story
**As a** Manager or Admin,
**I want** to track clinic expenses and basic inventory of supplies,
**so that** I can manage overhead costs and monitor supply levels.

## Acceptance Criteria
1. Expense tracking page accessible at `/dashboard/expenses` for manager and admin
2. Record expenses: date, category, description, amount, vendor, receipt (optional file upload)
3. Expense categories: Salaries, Supplies, Utilities, Rent, Equipment, Marketing, Other
4. Display expense list: date, category, description, amount, vendor
5. Filter by category and date range
6. Total expenses summary for selected period
7. Inventory section: item name, quantity, reorder level, unit cost, supplier
8. Low stock alert: highlight items where quantity <= reorder level
9. Update inventory quantity (add/subtract for purchases/usage)
10. API: GET/POST/PATCH/DELETE /api/expenses, GET/POST/PATCH /api/inventory
11. Expense model: id, expenseDate, category, description, amount, vendor, receiptUrl
12. Inventory model: id, itemName, quantity, reorderLevel, unitCost, supplier, lastUpdated
13. RBAC: manager and admin only
14. Brand-compliant UI
15. Export expenses to CSV (optional)

## Tasks / Subtasks

- [ ] **Task 1: Create Expense Model and Migration** (AC: 11)
  - [ ] Create `backend/models/Expense.js`
  - [ ] Fields: id (UUID), expenseDate, category (enum), description, amount, vendor, receiptUrl, createdBy
  - [ ] Create migration

- [ ] **Task 2: Create Inventory Model and Migration** (AC: 12)
  - [ ] Create `backend/models/InventoryItem.js`
  - [ ] Fields: id (UUID), itemName, quantity, reorderLevel, unitCost, supplier, lastUpdated
  - [ ] Create migration

- [ ] **Task 3: Implement Expense Controller** (AC: 10)
  - [ ] Create `backend/controllers/expenseController.js`
  - [ ] `listExpenses`: GET /api/expenses?category=XXX&startDate=XXX&endDate=XXX
  - [ ] `createExpense`: POST /api/expenses
  - [ ] `updateExpense`: PATCH /api/expenses/:id
  - [ ] `deleteExpense`: DELETE /api/expenses/:id

- [ ] **Task 4: Implement Inventory Controller** (AC: 10)
  - [ ] Create `backend/controllers/inventoryController.js`
  - [ ] `listInventory`: GET /api/inventory?lowStock=true
  - [ ] `createItem`: POST /api/inventory
  - [ ] `updateItem`: PATCH /api/inventory/:id (update quantity, reorder level, etc.)

- [ ] **Task 5: Create Routes with RBAC** (AC: 13)
  - [ ] Create `backend/routes/expenseRoutes.js` and `backend/routes/inventoryRoutes.js`
  - [ ] Apply authorizeRole(['manager', 'admin'])
  - [ ] Mount at `/api/expenses` and `/api/inventory`

- [ ] **Task 6: Create Expenses Page** (AC: 1, 2, 3)
  - [ ] Create `frontend/src/pages/ExpensesPage.jsx`
  - [ ] Two tabs: "Expenses" and "Inventory"
  - [ ] Expenses tab: list, filters, "Add Expense" button

- [ ] **Task 7: Expense Form Modal** (AC: 2)
  - [ ] Create `ExpenseFormModal`
  - [ ] Fields: expense date (date picker), category (dropdown), description (textarea), amount (number), vendor (text)
  - [ ] Optional: receipt file upload (future enhancement)
  - [ ] Save: POST /api/expenses

- [ ] **Task 8: Display Expense List** (AC: 4, 5, 6)
  - [ ] Table: Date, Category, Description, Amount, Vendor, Actions
  - [ ] Filter: category dropdown, date range inputs
  - [ ] Total summary at bottom: "Total Expenses: ฿{amount}"
  - [ ] Actions: Edit, Delete

- [ ] **Task 9: Inventory Tab** (AC: 7, 8, 9)
  - [ ] Display inventory items table
  - [ ] Columns: Item Name, Quantity, Reorder Level, Unit Cost, Supplier, Actions
  - [ ] Highlight row in amber if quantity <= reorderLevel
  - [ ] "Add Item" button
  - [ ] Actions: Update Quantity, Edit, Delete

- [ ] **Task 10: Update Quantity Modal** (AC: 9)
  - [ ] Modal with current quantity display
  - [ ] Input: Add (+) or Subtract (-) quantity
  - [ ] Reason dropdown: Purchase, Usage, Adjustment
  - [ ] Update button: PATCH /api/inventory/:id

- [ ] **Task 11: Update Staff Dashboard Navigation** (AC: 1)
  - [ ] Add "Expenses" nav item under Admin/Management section
  - [ ] Link to `/dashboard/expenses`
  - [ ] Visible for manager and admin

- [ ] **Task 12: Testing and Validation**
  - [ ] Add expense → saves and displays in list
  - [ ] Filter by category → shows only that category
  - [ ] Total summary calculates correctly
  - [ ] Add inventory item → saves
  - [ ] Update quantity → increments/decrements correctly
  - [ ] Low stock alert displays when quantity <= reorder level
  - [ ] RBAC: manager/admin can access, staff cannot

## Dev Notes

### Dependencies
Requires Epic 3 (authentication, RBAC).
Used by Story 5.1 (Executive Dashboard) and Story 5.2 (P&L Report).

### Expense Categories
```javascript
const EXPENSE_CATEGORIES = [
  'Salaries',
  'Supplies',
  'Utilities',
  'Rent',
  'Equipment',
  'Marketing',
  'Other'
];
```

### Low Stock Alert Logic
```javascript
// Frontend
const isLowStock = (item) => item.quantity <= item.reorderLevel;

// Display
<tr className={isLowStock(item) ? 'bg-amber-50' : ''}>
  {/* table cells */}
</tr>
```

### File Locations
**Backend:**
- `models/Expense.js` (NEW)
- `models/InventoryItem.js` (NEW)
- `controllers/expenseController.js` (NEW)
- `controllers/inventoryController.js` (NEW)
- `routes/expenseRoutes.js` (NEW)
- `routes/inventoryRoutes.js` (NEW)

**Frontend:**
- `pages/ExpensesPage.jsx` (NEW)
- `components/ExpenseFormModal.jsx` (NEW)
- `components/InventoryFormModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 5.4 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
