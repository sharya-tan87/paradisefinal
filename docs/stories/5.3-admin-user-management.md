# Story 5.3: Admin Tools - User Account Management

## Status
Done

## Story
**As an** Admin,
**I want** to create and manage user accounts for staff and dentists,
**so that** I can control system access and maintain user roles.

## Acceptance Criteria
1. Admin Tools page accessible at `/dashboard/admin` for admin role ONLY
2. Display list of all users: username, email, role, status (active/inactive)
3. Create new user form: username, email, password, role (staff, dentist, manager), firstName, lastName
4. Password must be hashed with bcrypt before storage (10+ salt rounds)
5. Edit user: update email, role, firstName, lastName (NOT username or password)
6. Deactivate/Activate user (soft delete: set active=false/true)
7. Reset user password (admin generates new temporary password)
8. User list filterable by role (all, admin, manager, dentist, staff)
9. Search users by username or email
10. API endpoints: GET /api/admin/users, POST /api/admin/users, PATCH /api/admin/users/:id, DELETE /api/admin/users/:id
11. RBAC: admin role ONLY (strictest access control)
12. Cannot delete own admin account (prevent lockout)
13. Brand-compliant UI with Prompt font
14. Success/error messages for all actions
15. Validation: unique username, unique email, strong password requirements

## Tasks / Subtasks

- [ ] **Task 1: Update User Model** (AC: 4, 6)
  - [ ] Verify User model from Story 3.1 has: id, username, password_hash, email, role, firstName, lastName, active (boolean)
  - [ ] If missing, add firstName, lastName, active fields
  - [ ] Create migration to add new fields if needed

- [ ] **Task 2: Create Admin Controller** (AC: 10)
  - [ ] Create `backend/controllers/adminController.js`
  - [ ] `listUsers`: GET /api/admin/users?role=XXX&search=XXX
  - [ ] `createUser`: POST /api/admin/users (hash password, validate uniqueness)
  - [ ] `updateUser`: PATCH /api/admin/users/:id (cannot change username or password via this endpoint)
  - [ ] `deactivateUser`: DELETE /api/admin/users/:id (set active=false, check not self)
  - [ ] `resetPassword`: POST /api/admin/users/:id/reset-password (generate temp password, hash, update)

- [ ] **Task 3: Create Admin Routes** (AC: 11)
  - [ ] Create `backend/routes/adminRoutes.js`
  - [ ] Apply RBAC: authorizeRole(['admin']) - admin ONLY
  - [ ] Mount at `/api/admin`

- [ ] **Task 4: Prevent Self-Deletion** (AC: 12)
  - [ ] In deactivateUser controller:
    ```javascript
    if (req.params.id === req.user.userId) {
      return res.status(400).json({ message: 'Cannot deactivate your own account' });
    }
    ```

- [ ] **Task 5: Create Admin Tools Page** (AC: 1, 13)
  - [ ] Create `frontend/src/pages/AdminToolsPage.jsx`
  - [ ] Layout: Header, title "User Management", user list, Footer
  - [ ] "Add User" button (Teal Blue)

- [ ] **Task 6: Display User List** (AC: 2, 8, 9)
  - [ ] Fetch GET /api/admin/users
  - [ ] Display table (desktop) / cards (mobile)
  - [ ] Columns: Username, Email, Role, Status (active badge), Actions
  - [ ] Filter dropdown by role
  - [ ] Search input (username/email)
  - [ ] Action buttons: Edit, Deactivate/Activate, Reset Password

- [ ] **Task 7: Create User Form Modal** (AC: 3, 5, 15)
  - [ ] Create `UserFormModal` component
  - [ ] Fields: username, email, password (create only), role (dropdown), firstName, lastName
  - [ ] Validation:
    - username required, min 3 chars
    - email required, valid format
    - password required (create mode), min 8 chars, must include uppercase, lowercase, number
    - role required (staff, dentist, manager, admin)
  - [ ] Create mode: POST /api/admin/users
  - [ ] Edit mode: PATCH /api/admin/users/:id (no password field)

- [ ] **Task 8: Implement Deactivate/Activate** (AC: 6, 14)
  - [ ] Deactivate button (red) calls DELETE /api/admin/users/:id
  - [ ] Activate button (green) calls PATCH /api/admin/users/:id with { active: true }
  - [ ] Confirmation modal: "Are you sure you want to deactivate {username}?"
  - [ ] Success message on action completion
  - [ ] Refresh user list

- [ ] **Task 9: Implement Password Reset** (AC: 7, 14)
  - [ ] Reset Password button opens modal
  - [ ] Modal: "Generate new temporary password for {username}?"
  - [ ] Backend generates random password (12 chars, includes uppercase, lowercase, number, symbol)
  - [ ] Hash password with bcrypt
  - [ ] Update user record
  - [ ] Return temporary password to admin (display in modal)
  - [ ] Admin copies temp password to share with user securely

- [ ] **Task 10: Update Staff Dashboard Navigation** (AC: 1)
  - [ ] Add "Admin Tools" nav item
  - [ ] Link to `/dashboard/admin`
  - [ ] Visible ONLY for admin role

- [ ] **Task 11: Apply Route Protection** (AC: 11)
  - [ ] Add `/dashboard/admin` route in App.jsx
  - [ ] ProtectedRoute: `allowedRoles={['admin']}`

- [ ] **Task 12: Testing and Validation**
  - [ ] Create new user → saves with hashed password
  - [ ] Edit user → updates fields except username/password
  - [ ] Deactivate user → sets active=false
  - [ ] Activate user → sets active=true
  - [ ] Try to deactivate own account → blocked with error message
  - [ ] Reset password → generates temp password, updates user
  - [ ] Filter by role → shows only users of that role
  - [ ] Search by username → finds match
  - [ ] RBAC: only admin can access

## Dev Notes

### Dependencies
Requires Epic 3 (User model from Story 3.1).

### Password Generation Utility
```javascript
// utils/passwordGenerator.js
const crypto = require('crypto');

function generateTempPassword() {
  const length = 12;
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let password = '';
  for (let i = 0; i < length; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}
```

### User Model Updates
```javascript
// Add to User model if missing
{
  firstName: DataTypes.STRING(100),
  lastName: DataTypes.STRING(100),
  active: DataTypes.BOOLEAN // default true
}
```

### File Locations
**Backend:**
- `controllers/adminController.js` (NEW)
- `routes/adminRoutes.js` (NEW)
- `utils/passwordGenerator.js` (NEW)
- `models/User.js` (update if needed)

**Frontend:**
- `pages/AdminToolsPage.jsx` (NEW)
- `components/UserFormModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 5.3 | Bob (Scrum Master) |

## Dev Agent Record

### Initial Implementation (2025-12-13)
Added firstName, lastName, and active fields to User model with migration. Created passwordGenerator.js utility for secure temporary passwords. Implemented adminController.js with CRUD operations, self-deletion prevention, and password reset functionality. Created adminRoutes.js with admin-only RBAC. Built AdminToolsPage.jsx with user list, search/filter, UserFormModal for create/edit, confirmation modals for activate/deactivate, and password reset modal that displays temp password once. Added all admin API methods to frontend service. Updated navigation and routing.

### Bug Fixes (2025-12-20)

**Issue Reported:** Session expires too quickly (15 minutes) and user list not displaying ("Invalid token" error).

**Root Causes Identified:**
1. **Database Port Misconfiguration:** Backend `.env` had `DB_PORT=3000` instead of `3306`, causing Sequelize to connect to wrong database instance
2. **Short Session Duration:** JWT access token set to 15 minutes, causing frequent logouts
3. **No Automatic Token Refresh:** Frontend had no interceptor to automatically refresh expired tokens

**Fixes Applied:**

1. **Extended JWT Token Expiry** (`/backend/.env`):
   - Access Token: `15m` → `8h` (8 hours - full workday session)
   - Refresh Token: `7d` → `30d` (30 days - monthly refresh)

2. **Fixed Database Port** (`/backend/.env`):
   - Changed `DB_PORT=3000` to `DB_PORT=3306` (correct MariaDB port)
   - This resolved "Invalid token" and "No users found" errors

3. **Implemented Automatic Token Refresh** (`/frontend/src/services/api.js`):
   - Added axios response interceptor to detect 401 errors
   - Automatically calls `/api/auth/refresh` with refresh token
   - Retries failed request with new access token
   - Prevents multiple simultaneous refresh calls with queue system
   - Redirects to login only when refresh token expires

4. **Updated Auth Controller** (`/backend/controllers/authController.js`):
   - Changed hardcoded token expiry to use environment variables
   - Access token: `process.env.JWT_ACCESS_EXPIRY || '8h'`
   - Refresh token: `process.env.JWT_REFRESH_EXPIRY || '30d'`

**Files Modified:**
- `/backend/.env` - JWT expiry + DB port configuration
- `/backend/controllers/authController.js` - Use env vars for token expiry
- `/frontend/src/services/api.js` - Added automatic token refresh interceptor

**Testing:**
- Created test script `backend/scripts/test-session-and-users.js`
- Verified login with 8-hour token expiry
- Confirmed user list displays all 5 users
- Tested token refresh endpoint
- Verified automatic token refresh works

**Impact:**
- Sessions now persist for 8 hours instead of 15 minutes
- Users only logged out on explicit logout or after 30 days of inactivity
- User list displays correctly with all users visible
- Seamless user experience with automatic background token refresh

## QA Results
_To be filled by QA Agent_
