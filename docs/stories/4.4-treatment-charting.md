# Story 4.4: Treatment Charting - Clinical Records

## Status
Done

## Story
**As a** Dentist,
**I want** to record treatment procedures and clinical notes for patients,
**so that** I can maintain accurate treatment history and plan future care.


## Acceptance Criteria
1. Treatment charting accessible at `/dashboard/treatments` for dentist, manager, admin (NOT staff)
2. Select patient to view/add treatments (search by HN or name)
3. Display patient's treatment history in reverse chronological order
4. Add new treatment record with: treatment date, procedure codes, description, tooth numbers, dentist, notes, cost
5. Treatment record includes: id, patientHN, appointmentId (optional FK), treatmentDate, procedureCodes (array), description, toothNumbers, performedBy (dentistId), clinicalNotes, estimatedCost, status
6. Procedure code dropdown with common dental procedures (e.g., "D0120 - Periodic Exam", "D1110 - Prophylaxis")
7. Tooth number selector (visual dental chart optional, or multi-select dropdown 1-32)
8. Treatment status: planned, in-progress, completed
9. API: GET /api/treatments?patientHN=XXX, POST /api/treatments, PATCH /api/treatments/:id
10. View treatment details in readonly modal
11. Edit treatment (only dentist who created it or admin)
12. Brand-compliant UI with Prompt font
13. RBAC: only dentist, manager, admin can access
14. Link treatments to appointments (optional FK)
15. Display treatment cost summary for patient

## Tasks / Subtasks

- [ ] **Task 1: Create Treatment Model and Migration** (AC: 5)
  - [ ] Create `backend/models/Treatment.js`
  - [ ] Fields: id (UUID), patientHN (FK), appointmentId (optional FK), treatmentDate, procedureCodes (JSON array), description, toothNumbers (JSON array), performedBy (FK to User.id), clinicalNotes, estimatedCost, status (enum), created_at, updated_at
  - [ ] Create migration with foreign keys
  - [ ] Add indexes on patientHN, performedBy

- [ ] **Task 2: Seed Procedure Codes** (AC: 6)
  - [ ] Create seeder with common dental procedure codes:
    - D0120 - Periodic Oral Evaluation
    - D1110 - Prophylaxis (Cleaning)
    - D2140 - Amalgam Filling
    - D2150 - Composite Filling
    - D2750 - Crown
    - D7140 - Extraction
    - ... (10-15 common procedures)
  - [ ] Store in ProcedureCode table or as JSON config

- [ ] **Task 3: Implement Treatment Controller** (AC: 9)
  - [ ] Create `backend/controllers/treatmentController.js`
  - [ ] `getTreatments`: GET /api/treatments?patientHN=HN-2025-00001
  - [ ] `createTreatment`: POST /api/treatments
  - [ ] `updateTreatment`: PATCH /api/treatments/:id (check if user created it or is admin)
  - [ ] `getTreatmentDetails`: GET /api/treatments/:id

- [ ] **Task 4: Create Treatment Routes with RBAC** (AC: 13)
  - [ ] Create `backend/routes/treatmentRoutes.js`
  - [ ] Apply authorizeRole(['dentist', 'manager', 'admin'])
  - [ ] Mount at `/api/treatments`

- [ ] **Task 5: Create Treatment Charting Page** (AC: 1, 2)
  - [ ] Create `frontend/src/pages/TreatmentChartingPage.jsx`
  - [ ] Patient search component (by HN or name)
  - [ ] Display selected patient's info card
  - [ ] "Add Treatment" button (visible when patient selected)

- [ ] **Task 6: Display Treatment History** (AC: 3, 15)
  - [ ] Fetch GET /api/treatments?patientHN=XXX
  - [ ] Display treatments in table (desktop) or cards (mobile)
  - [ ] Columns: Date, Procedures, Tooth Numbers, Dentist, Status, Cost, Actions
  - [ ] Sort by treatment date DESC
  - [ ] Show total cost summary at bottom

- [ ] **Task 7: Create Treatment Form Modal** (AC: 4, 6, 7, 8)
  - [ ] Create `TreatmentFormModal` component
  - [ ] Fields: treatment date (date picker), procedure codes (multi-select dropdown), description (textarea), tooth numbers (multi-select 1-32), clinical notes (textarea), estimated cost (number input), status (dropdown)
  - [ ] Validation: required fields (date, procedure codes, performedBy)
  - [ ] Save calls POST or PATCH /api/treatments

- [ ] **Task 8: Implement Tooth Number Selector** (AC: 7)
  - [ ] Multi-select dropdown with tooth numbers 1-32
  - [ ] Label: "Tooth Numbers (Universal Numbering)"
  - [ ] Allow multiple selections
  - [ ] Display selected teeth as comma-separated list

- [ ] **Task 9: View Treatment Details Modal** (AC: 10)
  - [ ] Display all treatment fields in readonly format
  - [ ] Show dentist name (lookup from User model)
  - [ ] Close button

- [ ] **Task 10: Implement Edit Permission Check** (AC: 11)
  - [ ] Only show Edit button if:
    - User is admin, OR
    - User is dentist who created the treatment (user.id === treatment.performedBy)
  - [ ] Backend validates same logic in PATCH endpoint

- [ ] **Task 11: Update Staff Dashboard Navigation** (AC: 1, 13)
  - [ ] "Treatments" link active for dentist/manager/admin
  - [ ] Link to `/dashboard/treatments`
  - [ ] Hide from staff role

- [ ] **Task 12: Testing and Validation**
  - [ ] Search patient → displays treatment history
  - [ ] Add new treatment → saves, appears in list
  - [ ] Edit treatment (created by logged-in dentist) → updates successfully
  - [ ] Try to edit another dentist's treatment (non-admin) → Edit button hidden
  - [ ] Admin can edit any treatment
  - [ ] Staff user cannot access page → unauthorized
  - [ ] Treatment cost summary calculates correctly

## Dev Notes

### Dependencies
Requires Epic 3, Story 4.2 (Patient model), Story 4.3 (Appointment model for optional FK).

### Treatment Model Schema
```javascript
{
  id: DataTypes.UUID,
  patientHN: DataTypes.STRING(50), // FK
  appointmentId: DataTypes.UUID, // Optional FK
  treatmentDate: DataTypes.DATEONLY,
  procedureCodes: DataTypes.JSON, // ['D0120', 'D1110']
  description: DataTypes.TEXT,
  toothNumbers: DataTypes.JSON, // [14, 15, 16]
  performedBy: DataTypes.UUID, // FK to User (dentist)
  clinicalNotes: DataTypes.TEXT,
  estimatedCost: DataTypes.DECIMAL(10, 2),
  status: DataTypes.ENUM('planned', 'in-progress', 'completed'),
  created_at: DataTypes.DATE,
  updated_at: DataTypes.DATE
}
```

### Procedure Codes (Sample)
- D0120 - Periodic Oral Evaluation - ฿500
- D1110 - Prophylaxis (Adult) - ฿800
- D2140 - Amalgam Filling (1 surface) - ฿1,200
- D2150 - Composite Filling (1 surface) - ฿1,500
- D2750 - Porcelain Crown - ฿8,000
- D7140 - Tooth Extraction - ฿1,500

### File Locations
**Backend:**
- `models/Treatment.js` (NEW)
- `controllers/treatmentController.js` (NEW)
- `routes/treatmentRoutes.js` (NEW)
- `seeders/procedure-codes.js` (NEW)

**Frontend:**
- `pages/TreatmentChartingPage.jsx` (NEW)
- `components/TreatmentFormModal.jsx` (NEW)
- `components/ViewTreatmentModal.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 4.4 | Bob (Scrum Master) |

## Dev Agent Record
Implemented Treatment model, controller, routes, and frontend page with modals. Used JSON config for procedure codes. Confirmed RBAC and validations.

## QA Results
_To be filled by QA Agent_
