# Story 4.1: Queue Management Dashboard

## Status
Done

## Story
**As a** Staff Member or Manager,
**I want** a dashboard to view and manage incoming appointment requests from the public booking system,
**so that** I can approve, reject, or contact patients regarding their booking requests.

## Acceptance Criteria
1. Queue dashboard accessible at `/dashboard/queue` for staff, dentist, manager, and admin roles
2. Dashboard displays list of appointment requests from Epic 2 (public booking system)
3. Each request shows: request ID, patient name, phone, email, preferred date/time, service type, status
4. Requests displayed in reverse chronological order (newest first)
5. Filter options: status (all, pending, contacted, confirmed, cancelled, completed)
6. Status badge color-coded: pending (amber), contacted (blue), confirmed (green), cancelled (red), completed (gray)
7. Each request has action buttons: View Details, Update Status, Contact Patient
8. Update Status modal allows changing status with confirmation
9. View Details modal shows full request information including notes
10. API endpoint `GET /api/appointments` returns paginated list with filters
11. API endpoint `PATCH /api/appointments/:requestId/status` updates status (from Story 2.x)
12. Only staff, dentist, manager, admin can access (RBAC enforced)
13. Page uses brand colors, Prompt font, white background
14. Responsive layout: table on desktop, cards on mobile
15. Real-time request count badge in Staff Dashboard navigation

## Tasks / Subtasks

- [x] **Task 1: Create Queue Dashboard Component** (AC: 1, 13, 14)
  - [x] Create `frontend/src/pages/QueueDashboard.jsx`
  - [x] Set up layout with Header and Footer
  - [x] White background, Prompt font
  - [x] Page title: "Appointment Queue"
  - [x] Responsive container (max-width on desktop)

- [x] **Task 2: Fetch Appointment Requests from API** (AC: 2, 10)
  - [x] Create API service function `getAppointmentRequests(filters, page, limit)`
  - [x] Use existing `GET /api/appointments` endpoint
  - [x] Include Authorization header with access token
  - [x] Handle pagination (default: page 1, limit 20)
  - [x] Handle filter parameters (status)

- [x] **Task 3: Display Requests in Table (Desktop)** (AC: 3, 4, 14)
  - [x] Create table component with columns:
    - [x] Request ID
    - [x] Patient Name
    - [x] Phone
    - [x] Email
    - [x] Preferred Date/Time
    - [x] Service Type
    - [x] Status (badge)
    - [x] Actions (buttons)
  - [x] Sort by created_at DESC (newest first)
  - [x] Style table with brand colors (Light Blue borders, Deep Navy headers)

- [x] **Task 4: Display Requests in Cards (Mobile)** (AC: 3, 14)
  - [x] Create card component for mobile view
  - [x] Each card shows same information as table row
  - [x] Stack cards vertically
  - [x] Show on screens < 768px
  - [x] Style cards with white bg, Light Blue border

- [x] **Task 5: Implement Status Badge Component** (AC: 6)
  - [x] Create reusable StatusBadge component
  - [x] Color mapping:
    - [x] pending: bg-amber-100, text-amber-800
    - [x] contacted: bg-blue-100, text-blue-800
    - [x] confirmed: bg-green-100, text-green-800
    - [x] cancelled: bg-red-100, text-red-800
    - [x] completed: bg-gray-100, text-gray-800
  - [x] Rounded pill shape, small text

- [x] **Task 6: Add Filter Dropdown** (AC: 5)
  - [x] Create filter select dropdown for status
  - [x] Options: All, Pending, Contacted, Confirmed, Cancelled, Completed
  - [x] On change, re-fetch requests with status filter
  - [x] Style with brand colors (Teal Blue focus ring)

- [x] **Task 7: Create View Details Modal** (AC: 9)
  - [x] Create modal component to display full request details
  - [x] Show all fields including notes
  - [x] Display timestamps (created_at, updated_at)
  - [x] Close button (X icon from Lucide React)
  - [x] Overlay with semi-transparent background
  - [x] Modal card with brand styling

- [x] **Task 8: Create Update Status Modal** (AC: 8, 11)
  - [x] Create modal with status dropdown
  - [x] Dropdown options: pending, contacted, confirmed, cancelled, completed
  - [x] Confirm button (Teal Blue)
  - [x] Cancel button (gray)
  - [x] Call `PATCH /api/appointments/:requestId/status` API
  - [x] Show success message on update
  - [x] Refresh request list after update

- [x] **Task 9: Add Action Buttons** (AC: 7)
  - [x] View Details button (Eye icon, Teal Blue)
  - [x] Update Status button (Edit icon, Deep Navy)
  - [x] Contact Patient button (Phone icon, green) - placeholder link (tel:)
  - [x] Button group with spacing
  - [x] Responsive: full-width on mobile, inline on desktop

- [x] **Task 10: Implement Pagination** (AC: 10)
  - [x] Add pagination controls (Previous, Next)
  - [x] Show current page and total pages
  - [x] Fetch new page on button click
  - [x] Disable Previous on page 1, disable Next on last page
  - [x] Style with brand colors

- [x] **Task 11: Update Staff Dashboard Navigation** (AC: 15)
  - [x] Update `StaffDashboard.jsx` from Story 3.5
  - [x] Change "Queue Management" from coming soon to active link
  - [x] Link to `/dashboard/queue`
  - [x] Add badge showing count of pending requests (optional enhancement)

- [x] **Task 12: Apply RBAC Protection** (AC: 12)
  - [x] Update `App.jsx` route definition
  - [x] Wrap route with ProtectedRoute: `allowedRoles={['staff', 'dentist', 'manager', 'admin']}`
  - [x] Verify backend endpoint has same RBAC (from Story 3.3)

- [x] **Task 13: Testing and Validation**
  - [x] **API Integration:**
    - [x] Login as staff → GET `/api/appointments` → returns list of requests
    - [x] Filter by status "pending" → returns only pending requests
    - [x] Update request status → PATCH succeeds, list refreshes
  - [x] **UI/UX:**
    - [x] Desktop view shows table layout
    - [x] Mobile view shows card layout
    - [x] Status badges display correct colors
    - [x] Modals open and close correctly
  - [x] **RBAC:**
    - [x] Staff can access queue dashboard
    - [x] Patient cannot access → redirects to unauthorized
  - [x] **Brand Compliance:**
    - [x] Only brand colors used
    - [x] Prompt font throughout
    - [x] White background
  - [x] **Functionality:**
    - [x] Requests sorted newest first
    - [x] Pagination works (previous/next)
    - [x] View details shows all data
    - [x] Update status changes status and refreshes list
    - [x] Filter dropdown filters correctly

## Dev Notes

### Previous Story Context
[Source: Story 2.1, 2.2, 2.3, 2.4 - Epic 2 completed]

Epic 2 implemented:
- Public appointment request form at `/booking`
- API endpoint: `POST /api/appointments/request`
- AppointmentRequest model with fields: requestId, name, phone, email, preferredDate, preferredTime, serviceType, notes, status
- Status values: pending, contacted, confirmed, cancelled, completed
- Email/SMS notification system (may fail gracefully if not configured)

[Source: Story 3.x - Epic 3 completed]

Epic 3 implemented:
- JWT authentication and session management
- Role-based access control (RBAC)
- Staff dashboard with navigation placeholders
- Protected routes with role checking

**Dependencies:** This story REQUIRES Epic 2 (Stories 2.1-2.4) and Epic 3 (Stories 3.1-3.5) to be completed first.

### Technology Stack
[Source: docs/architecture/2-technology-stack.md]

**Frontend:**
- React 18.x with React Hook Form
- Lucide React icons
- Tailwind CSS for styling
- Axios for API calls

**Backend:**
- Express.js REST API
- Sequelize ORM with MariaDB
- JWT authentication middleware (from Story 3.1)
- RBAC middleware (from Story 3.3)

### API Endpoints
[Source: Story 2.1 implementation and appointmentController.js]

**GET /api/appointments**
- Query params: `status`, `page`, `limit`
- Returns: `{ success: true, data: [...], pagination: { total, page, limit, totalPages } }`
- Auth: Required (JWT token)
- RBAC: staff, dentist, manager, admin

**PATCH /api/appointments/:requestId/status**
- Body: `{ status: 'pending' | 'contacted' | 'confirmed' | 'cancelled' | 'completed' }`
- Returns: `{ success: true, message: 'Appointment status updated successfully' }`
- Auth: Required
- RBAC: admin, manager, staff

### Appointment Request Data Model
[Source: backend/models/AppointmentRequest.js from Story 2.1]

```javascript
{
  id: INTEGER,
  requestId: STRING, // "REQ-2025-00001"
  name: STRING,
  phone: STRING,
  email: STRING,
  preferredDate: DATE,
  preferredTime: STRING,
  serviceType: ENUM('General Checkup', 'Teeth Cleaning', 'Cosmetic Dentistry', 'Orthodontics', 'Dental Implants', 'Other'),
  notes: TEXT,
  status: ENUM('pending', 'contacted', 'confirmed', 'cancelled', 'completed'),
  emailSent: BOOLEAN,
  smsSent: BOOLEAN,
  ipAddress: STRING,
  userAgent: STRING,
  created_at: DATE,
  updated_at: DATE
}
```

### Brand Compliance
[Source: docs/prd/8-uiux-specifications.md, docs/prd/3-non-functional-requirements-nfrs.md]

**Status Badge Colors:**
- Pending: Amber (#F59E0B background tint, #92400E text)
- Contacted: Blue (#3B82F6 background tint, #1E40AF text)
- Confirmed: Green (#10B981 background tint, #065F46 text)
- Cancelled: Red (#EF4444 background tint, #991B1B text)
- Completed: Gray (#6B7280 background tint, #374151 text)

**Table Styling:**
```css
Table:
- Background: #FFFFFF (White)
- Border: 1px solid #CEE0F3 (Light Blue)
- Header: bg-primary-50 (#F0F7FF), text-primary-900 (#214491)
- Row borders: border-b border-gray-100
- Hover: bg-gray-50
```

**Action Buttons:**
```css
Primary Action (View, Update):
- Icon: Teal Blue (#2D7C9C)
- Hover: Deep Navy (#214491)
- Size: 20px
```

### Responsive Design Pattern
[Source: docs/architecture/3-frontend-architecture-ux-patterns.md]

**Desktop (>= 768px):**
- Display as data table
- Fixed columns, scrollable if needed
- Action buttons inline

**Mobile (< 768px):**
- Display as stacked cards
- Full-width cards with margin
- Action buttons stacked or in button group

### Modal Pattern
[Source: Frontend UX patterns]

**Modal Overlay:**
```javascript
<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div className="bg-white rounded-xl border border-primary-100 shadow-lg max-w-lg w-full mx-4 p-6">
    {/* Modal content */}
  </div>
</div>
```

### File Locations
[Source: Frontend structure from Epic 3]

**Frontend Files:**
```
frontend/src/
├── pages/
│   ├── QueueDashboard.jsx (NEW)
│   ├── StaffDashboard.jsx (update navigation)
│   └── ... (existing pages)
├── components/
│   ├── StatusBadge.jsx (NEW - reusable)
│   ├── ViewDetailsModal.jsx (NEW)
│   └── UpdateStatusModal.jsx (NEW)
├── services/
│   └── api.js (add getAppointmentRequests, updateAppointmentStatus)
└── App.jsx (add /dashboard/queue route)
```

**Backend Files:**
```
backend/
├── routes/
│   └── appointmentRoutes.js (already has GET and PATCH endpoints)
├── controllers/
│   └── appointmentController.js (already implemented)
├── middleware/
│   ├── authenticate.js (from Story 3.1)
│   └── authorizeRole.js (from Story 3.3)
└── models/
    └── AppointmentRequest.js (from Story 2.1)
```

### Testing Standards

**Manual Testing:**

1. **API Tests (curl):**
```bash
# Login as staff
TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"staff","password":"password123"}' | jq -r '.accessToken')

# Get all appointments
curl -X GET "http://localhost:3001/api/appointments" \
  -H "Authorization: Bearer $TOKEN"

# Get pending appointments
curl -X GET "http://localhost:3001/api/appointments?status=pending" \
  -H "Authorization: Bearer $TOKEN"

# Update status
curl -X PATCH "http://localhost:3001/api/appointments/REQ-2025-00001/status" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"status":"contacted"}'
```

2. **Frontend Tests:**
- Login as staff → navigate to Queue dashboard → see list of requests
- Filter by "Pending" → only pending requests shown
- Click "View Details" → modal opens with full data
- Click "Update Status" → modal opens, change status to "Contacted", confirm → status updates
- Test on mobile (375px width) → cards display instead of table
- Test pagination → navigate between pages

3. **RBAC Tests:**
- Staff user can access queue
- Patient user cannot access → redirects to unauthorized

4. **Brand Compliance:**
- Verify only brand colors
- Verify Prompt font
- Verify status badge colors match specifications

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 4.1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
