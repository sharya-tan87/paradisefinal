# Story 5.1: Executive Dashboard with Analytics

## Status
Done

## Story
**As a** Manager or Admin,
**I want** a visual dashboard with key performance indicators and charts,
**so that** I can monitor clinic revenue, patient count, and appointment efficiency at a glance.

## Acceptance Criteria
1. Executive dashboard accessible at `/dashboard/analytics` for manager and admin roles only
2. Dashboard displays 4 KPI cards: Total Revenue (current month), Active Patients, Appointments This Month, Appointment Fill Rate
3. Revenue chart (line or bar chart) showing monthly revenue for past 6 months
4. Patient growth chart showing new patients per month for past 6 months
5. Appointment status breakdown (pie or donut chart): scheduled, completed, cancelled, no-show
6. All charts use brand colors ONLY: `#CEE0F3`, `#2D7C9C`, `#214491`
7. Charts built with Recharts library (minimalist styling)
8. API endpoint: GET /api/analytics/dashboard returns KPIs and chart data
9. Real-time data updates (fetch on page load, refresh button optional)
10. Responsive layout: cards stack on mobile, 2x2 grid on desktop
11. Date range filter: This Month, Last 3 Months, Last 6 Months, This Year
12. RBAC: manager and admin only (NOT staff, dentist, patient)
13. Loading states with skeleton UI while fetching data
14. Brand-compliant design: white background, Prompt font
15. Export dashboard summary to PDF (optional enhancement for future)

## Tasks / Subtasks

- [ ] **Task 1: Create Analytics Controller** (AC: 8)
  - [ ] Create `backend/controllers/analyticsController.js`
  - [ ] Implement `getDashboardMetrics(req, res)`:
    - [ ] Calculate total revenue (sum of paid invoices for period)
    - [ ] Count active patients (active=true)
    - [ ] Count appointments this month
    - [ ] Calculate appointment fill rate (completed / total scheduled)
    - [ ] Get monthly revenue for past 6 months (group by month)
    - [ ] Get new patients per month for past 6 months
    - [ ] Get appointment status breakdown counts
  - [ ] Return JSON with all metrics

- [ ] **Task 2: Create Analytics Routes** (AC: 12)
  - [ ] Create `backend/routes/analyticsRoutes.js`
  - [ ] Route: GET /api/analytics/dashboard?dateRange=6months
  - [ ] Apply RBAC: authorizeRole(['manager', 'admin'])
  - [ ] Mount at `/api/analytics`

- [ ] **Task 3: Create Executive Dashboard Page** (AC: 1, 14)
  - [ ] Create `frontend/src/pages/AnalyticsDashboard.jsx`
  - [ ] Layout: Header, main content area with KPI cards and charts, Footer
  - [ ] White background, Prompt font
  - [ ] Page title: "Executive Dashboard"

- [ ] **Task 4: Create KPI Card Components** (AC: 2, 10)
  - [ ] Create 4 KPI cards:
    1. Total Revenue: Display amount in Thai Baht (฿), icon: DollarSign (Teal Blue)
    2. Active Patients: Display count, icon: Users (Teal Blue)
    3. Appointments This Month: Display count, icon: Calendar (Teal Blue)
    4. Fill Rate: Display percentage, icon: TrendingUp (Teal Blue)
  - [ ] Style cards: white bg, Light Blue border, rounded, soft shadow
  - [ ] Responsive: stack on mobile, 2x2 grid on desktop

- [ ] **Task 5: Install and Configure Recharts** (AC: 7)
  - [ ] Install: `npm install recharts`
  - [ ] Import components: LineChart, BarChart, PieChart, Line, Bar, Pie, XAxis, YAxis, Tooltip, Legend, Cell

- [ ] **Task 6: Create Revenue Chart** (AC: 3, 6)
  - [ ] Use LineChart or BarChart component
  - [ ] Data: monthly revenue for past 6 months
  - [ ] X-axis: Month labels (Jan, Feb, Mar...)
  - [ ] Y-axis: Revenue amount (฿)
  - [ ] Line/Bar color: Teal Blue (#2D7C9C)
  - [ ] Tooltip shows exact revenue
  - [ ] Minimalist styling: no grid lines, clean design

- [ ] **Task 7: Create Patient Growth Chart** (AC: 4, 6)
  - [ ] Use BarChart component
  - [ ] Data: new patients per month for past 6 months
  - [ ] X-axis: Months
  - [ ] Y-axis: Patient count
  - [ ] Bar color: Deep Navy (#214491)
  - [ ] Tooltip shows exact count

- [ ] **Task 8: Create Appointment Status Chart** (AC: 5, 6)
  - [ ] Use PieChart or Donut Chart
  - [ ] Segments: scheduled, completed, cancelled, no-show
  - [ ] Colors (map to brand palette):
    - scheduled: Light Blue (#CEE0F3)
    - completed: Teal Blue (#2D7C9C)
    - cancelled: Deep Navy (#214491)
    - no-show: Gray (#9CA3AF)
  - [ ] Show percentage labels
  - [ ] Legend with counts

- [ ] **Task 9: Add Date Range Filter** (AC: 11)
  - [ ] Dropdown: "This Month", "Last 3 Months", "Last 6 Months", "This Year"
  - [ ] On change, re-fetch analytics with dateRange parameter
  - [ ] Update all charts based on selected range

- [ ] **Task 10: Implement Loading States** (AC: 13)
  - [ ] Show skeleton UI while loading:
    - KPI cards: gray boxes with pulse animation
    - Charts: gray rectangles with pulse
  - [ ] Use Tailwind's `animate-pulse` utility
  - [ ] Hide skeleton, show content when data loaded

- [ ] **Task 11: Update Staff Dashboard Navigation** (AC: 1, 12)
  - [ ] Add "Reports" nav item in StaffDashboard
  - [ ] Link to `/dashboard/analytics`
  - [ ] Visible only for manager and admin roles
  - [ ] Icon: BarChart (Lucide React)

- [ ] **Task 12: Apply Route Protection** (AC: 12)
  - [ ] Add `/dashboard/analytics` route in App.jsx
  - [ ] Wrap with ProtectedRoute: `allowedRoles={['manager', 'admin']}`
  - [ ] Verify backend endpoint has same RBAC

- [ ] **Task 13: Testing and Validation**
  - [ ] **Data Accuracy:**
    - [ ] Verify total revenue matches sum of paid invoices
    - [ ] Verify active patient count correct
    - [ ] Verify appointment fill rate calculation correct
  - [ ] **Charts:**
    - [ ] Revenue chart displays correct monthly data
    - [ ] Patient growth chart shows new patient counts
    - [ ] Status pie chart percentages add to 100%
  - [ ] **RBAC:**
    - [ ] Manager can access dashboard
    - [ ] Admin can access dashboard
    - [ ] Staff cannot access → unauthorized redirect
  - [ ] **Brand Compliance:**
    - [ ] Only brand colors used in charts
    - [ ] White background
    - [ ] Prompt font throughout
  - [ ] **Responsive:**
    - [ ] Mobile: KPI cards stack vertically, charts full-width
    - [ ] Desktop: 2x2 grid for KPIs, charts side-by-side

## Dev Notes

### Dependencies
Requires Epic 4 completed (Patient, Appointment, Invoice models for data aggregation).

### Analytics Metrics Calculation

**Total Revenue (Current Month):**
```javascript
const startOfMonth = new Date(year, month, 1);
const endOfMonth = new Date(year, month + 1, 0);

const revenue = await Invoice.sum('totalAmount', {
  where: {
    paymentStatus: 'paid',
    paymentDate: { [Op.between]: [startOfMonth, endOfMonth] }
  }
});
```

**Active Patients:**
```javascript
const activePatients = await Patient.count({
  where: { active: true }
});
```

**Appointment Fill Rate:**
```javascript
const total = await Appointment.count({ where: { status: { [Op.in]: ['scheduled', 'completed'] } } });
const completed = await Appointment.count({ where: { status: 'completed' } });
const fillRate = (completed / total * 100).toFixed(1);
```

**Monthly Revenue (Past 6 Months):**
```javascript
// Group invoices by month, sum totalAmount
const monthlyRevenue = await Invoice.findAll({
  attributes: [
    [sequelize.fn('DATE_FORMAT', sequelize.col('invoiceDate'), '%Y-%m'), 'month'],
    [sequelize.fn('SUM', sequelize.col('totalAmount')), 'revenue']
  ],
  where: {
    paymentStatus: 'paid',
    invoiceDate: { [Op.gte]: sixMonthsAgo }
  },
  group: ['month'],
  order: [['month', 'ASC']]
});
```

### Recharts Brand Styling
[Source: docs/prd/3-non-functional-requirements-nfrs.md - UI-001]

```jsx
<LineChart data={revenueData} width={600} height={300}>
  <XAxis dataKey="month" stroke="#214491" />
  <YAxis stroke="#214491" />
  <Tooltip contentStyle={{ backgroundColor: '#FFFFFF', border: '1px solid #CEE0F3' }} />
  <Line type="monotone" dataKey="revenue" stroke="#2D7C9C" strokeWidth={2} />
</LineChart>
```

**CRITICAL:** Charts must use ONLY the three brand colors:
- `#CEE0F3` (Light Blue)
- `#2D7C9C` (Teal Blue)
- `#214491` (Deep Navy)

No other colors allowed (no default Recharts blue, green, orange, etc.).

### File Locations

**Backend:**
```
backend/
├── controllers/
│   └── analyticsController.js (NEW)
└── routes/
    └── analyticsRoutes.js (NEW)
```

**Frontend:**
```
frontend/src/
├── pages/
│   └── AnalyticsDashboard.jsx (NEW)
└── components/
    ├── KPICard.jsx (NEW - reusable)
    ├── RevenueChart.jsx (NEW)
    ├── PatientGrowthChart.jsx (NEW)
    └── AppointmentStatusChart.jsx (NEW)
```

### Testing Standards

**Manual Testing:**

1. **API Tests:**
```bash
# Login as manager
TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"manager","password":"password123"}' | jq -r '.accessToken')

# Get dashboard analytics
curl -X GET "http://localhost:3001/api/analytics/dashboard?dateRange=6months" \
  -H "Authorization: Bearer $TOKEN"
```

2. **Frontend Tests:**
- Login as manager → access analytics dashboard → see KPIs and charts
- Change date range filter → charts update with new data
- Verify revenue matches invoice totals (manually check database)
- Test on mobile → cards stack, charts responsive

3. **RBAC Tests:**
- Manager can access
- Admin can access
- Staff cannot access → unauthorized redirect

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 5.1 | Bob (Scrum Master) |

## Dev Agent Record
Implemented analytics controller with KPI calculations (total revenue, active patients, appointments this month, fill rate) and chart data aggregation (monthly revenue, patient growth, appointment status breakdown). Created routes with RBAC for manager/admin only. Installed Recharts and created AnalyticsDashboard.jsx with 4 KPI cards, LineChart for revenue, BarChart for patient growth, and PieChart for appointment status. Used only brand colors (#CEE0F3, #2D7C9C, #214491). Added date range filter, loading states with skeleton UI, and responsive layout. Updated navigation in StaffDashboard.

## QA Results
_To be filled by QA Agent_
