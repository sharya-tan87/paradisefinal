# Story 5.2: Reporting Engine - PDF/CSV Reports

## Status
Done

## Story
**As a** Manager or Admin,
**I want** to generate financial reports (P&L, Daily Collections) in PDF and CSV formats,
**so that** I can analyze clinic performance and share reports with stakeholders.

## Acceptance Criteria
1. Reports page accessible at `/dashboard/reports` for manager and admin only
2. Report types: Profit & Loss (P&L), Daily Collections, Monthly Revenue Summary
3. Date range selector for all reports (start date, end date)
4. Generate Report button triggers API call and downloads file
5. P&L Report includes: total revenue, total expenses, net profit, breakdown by category
6. Daily Collections Report includes: date, invoice number, patient, amount, payment method
7. Monthly Revenue Summary includes: month, total revenue, invoice count, average invoice value
8. Export formats: PDF and CSV (user selects format)
9. PDF reports use brand styling (clinic logo placeholder, Teal Blue headers, white background)
10. CSV reports include all data fields with proper formatting
11. API endpoints: GET /api/reports/p-and-l, GET /api/reports/daily-collections, GET /api/reports/monthly-summary
12. Backend generates PDF using PDFKit or html-pdf library
13. CSV generation uses json2csv library
14. RBAC: manager and admin only
15. Loading indicator while report generates

## Tasks / Subtasks

- [ ] **Task 1: Install Report Generation Libraries** (AC: 12, 13)
  - [ ] Install PDFKit: `npm install pdfkit`
  - [ ] Install json2csv: `npm install json2csv`
  - [ ] Or alternative: `npm install html-pdf` (converts HTML to PDF)

- [ ] **Task 2: Create Reports Controller** (AC: 11)
  - [ ] Create `backend/controllers/reportsController.js`
  - [ ] `generatePandL(req, res)`: GET /api/reports/p-and-l?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD&format=pdf|csv
  - [ ] `generateDailyCollections(req, res)`: GET /api/reports/daily-collections?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD&format=pdf|csv
  - [ ] `generateMonthlySummary(req, res)`: GET /api/reports/monthly-summary?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD&format=pdf|csv

- [ ] **Task 3: Implement P&L Report Logic** (AC: 5)
  - [ ] Query invoices (revenue) for date range
  - [ ] Query expenses for date range (from Story 5.4)
  - [ ] Calculate: Total Revenue, Total Expenses, Net Profit
  - [ ] Breakdown by category (service types for revenue, expense categories for costs)
  - [ ] Return data object or generate file

- [ ] **Task 4: Implement Daily Collections Logic** (AC: 6)
  - [ ] Query invoices with paymentStatus='paid' for date range
  - [ ] Include: paymentDate, invoiceNumber, patientName (join Patient), totalAmount, paymentMethod
  - [ ] Sort by paymentDate ASC
  - [ ] Return data or generate file

- [ ] **Task 5: Implement Monthly Summary Logic** (AC: 7)
  - [ ] Group invoices by month (DATE_FORMAT)
  - [ ] Aggregate: SUM(totalAmount), COUNT(*), AVG(totalAmount)
  - [ ] Return monthly data

- [ ] **Task 6: Create PDF Generation Functions** (AC: 9, 12)
  - [ ] Create `utils/pdfGenerator.js`
  - [ ] Function `generatePandLPDF(data)`:
    - [ ] Header: "Profit & Loss Report" (Deep Navy)
    - [ ] Date range
    - [ ] Table: Revenue breakdown, Expenses breakdown
    - [ ] Footer: Total Revenue, Total Expenses, Net Profit
    - [ ] Brand styling: white bg, Teal Blue headers
  - [ ] Function `generateDailyCollectionsPDF(data)`:
    - [ ] Table with columns: Date, Invoice #, Patient, Amount, Method
  - [ ] Return PDF buffer

- [ ] **Task 7: Create CSV Generation Functions** (AC: 10, 13)
  - [ ] Create `utils/csvGenerator.js`
  - [ ] Use json2csv library
  - [ ] Convert data arrays to CSV strings
  - [ ] Return CSV content

- [ ] **Task 8: Create Reports Routes** (AC: 14)
  - [ ] Create `backend/routes/reportsRoutes.js`
  - [ ] Apply RBAC: authorizeRole(['manager', 'admin'])
  - [ ] Mount at `/api/reports`

- [ ] **Task 9: Create Reports Page** (AC: 1, 2, 3, 8)
  - [ ] Create `frontend/src/pages/ReportsPage.jsx`
  - [ ] Report type selector (dropdown): P&L, Daily Collections, Monthly Summary
  - [ ] Date range inputs: start date, end date
  - [ ] Format selector (radio buttons): PDF, CSV
  - [ ] "Generate Report" button (Teal Blue)

- [ ] **Task 10: Implement Report Download** (AC: 4, 15)
  - [ ] On button click, show loading spinner
  - [ ] Call API: GET /api/reports/{type}?startDate=XXX&endDate=XXX&format=XXX
  - [ ] Receive file as blob response
  - [ ] Trigger browser download with filename: `{report-type}_{date-range}.{format}`
  - [ ] Hide loading spinner

- [ ] **Task 11: Update Staff Dashboard Navigation** (AC: 1)
  - [ ] Add "Reports" sub-item under Analytics/Reports section
  - [ ] Link to `/dashboard/reports`
  - [ ] Visible for manager and admin only

- [ ] **Task 12: Testing and Validation**
  - [ ] Generate P&L PDF → downloads branded PDF with correct calculations
  - [ ] Generate P&L CSV → downloads CSV with all data
  - [ ] Generate Daily Collections PDF → table formatted correctly
  - [ ] Generate Monthly Summary CSV → data accurate
  - [ ] Verify PDF brand styling (white bg, Teal headers, Deep Navy text)
  - [ ] RBAC: manager/admin can access, staff cannot

## Dev Notes

### Dependencies
Requires Epic 4 (Invoice, Patient models) and Story 5.4 (Expense model for P&L).

### P&L Calculation Logic
```javascript
// Revenue
const revenue = await Invoice.sum('totalAmount', {
  where: {
    paymentStatus: 'paid',
    paymentDate: { [Op.between]: [startDate, endDate] }
  }
});

// Expenses (from Story 5.4)
const expenses = await Expense.sum('amount', {
  where: {
    expenseDate: { [Op.between]: [startDate, endDate] }
  }
});

// Net Profit
const netProfit = revenue - expenses;
```

### PDFKit Example
```javascript
const PDFDocument = require('pdfkit');

function generatePandLPDF(data) {
  const doc = new PDFDocument();

  // Header
  doc.fontSize(20).fillColor('#214491').text('Profit & Loss Report', { align: 'center' });
  doc.fontSize(12).fillColor('#2D7C9C').text(`Period: ${data.startDate} to ${data.endDate}`, { align: 'center' });

  // Table
  doc.fontSize(14).fillColor('#214491').text('Revenue', { underline: true });
  data.revenueBreakdown.forEach(item => {
    doc.fontSize(10).fillColor('#000000').text(`${item.category}: ฿${item.amount}`);
  });

  // Summary
  doc.fontSize(14).fillColor('#214491').text(`Total Revenue: ฿${data.totalRevenue}`);
  doc.text(`Total Expenses: ฿${data.totalExpenses}`);
  doc.text(`Net Profit: ฿${data.netProfit}`);

  doc.end();
  return doc;
}
```

### CSV Example
```javascript
const { parse } = require('json2csv');

function generateDailyCollectionsCSV(data) {
  const fields = ['Date', 'Invoice Number', 'Patient Name', 'Amount', 'Payment Method'];
  const csv = parse(data, { fields });
  return csv;
}
```

### File Locations
**Backend:**
- `controllers/reportsController.js` (NEW)
- `routes/reportsRoutes.js` (NEW)
- `utils/pdfGenerator.js` (NEW)
- `utils/csvGenerator.js` (NEW)

**Frontend:**
- `pages/ReportsPage.jsx` (NEW)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story creation for Epic 5.2 | Bob (Scrum Master) |

## Dev Agent Record
Installed pdfkit and json2csv libraries. Created pdfGenerator.js with brand-styled PDF generation for P&L, Daily Collections, and Monthly Summary reports. Created csvGenerator.js for CSV exports. Implemented reportsController.js with three report endpoints that query Invoice data and generate files. Created reportsRoutes.js with RBAC for manager/admin only. Built ReportsPage.jsx with report type selection cards, date range picker, format selector (PDF/CSV), and download functionality with loading states. Added route and navigation link from AnalyticsDashboard.

## QA Results
_To be filled by QA Agent_
